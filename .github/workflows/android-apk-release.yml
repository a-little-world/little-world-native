name: Android APK (EAS local) Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., apk-v1.2.3)"
        required: true
      name:
        description: "Release name (optional)"
        required: false
      prerelease:
        description: "Mark as prerelease (true/false)"
        required: true
        default: "true"
      baseUrl:
        description: "Base URL for backend (e.g., https://api.example.com)"
        required: false
        default: ""
      encryptedAppSecret:
        description: "Encrypted device secret"
        required: false
        default: "LVObrvZAgT/BcObWoRnc5RdYQ/mF3os9:1bfORapXAmhRG2ONi+BHNc8AE6ThyabiV+dCIdBMXSnvx3OBThmgNLWlom0DTfjDlGo7fwn/YbiIwvCgQ+reVngpti/kPjU/yd65yiKdr5AwrQbwk36hngaBPNR32T6sp6gSUDX1/hPK"
      innerLayerDecryptionKey:
        description: "Inner layer decryption key"
        required: false
        default: "T/MWGCeO/XlhKTbp/wullhh2yG4XMMOpHWH3NQMNBXQ="
      developmentOnlyOuterLayerDecryptionKey:
        description: "Development only outer layer decryption key"
        required: false
        default: "kEzw1Rd5axcHUj9Mg0UhZv1PRuHAPV0OkKDSiS9h6uU="
      COMMIT_REF:
        description: "Frontend commit SHA or branch to checkout"
        required: false
        default: "main"
      googleCloudProjectID:
        description: "Google Project ID for cloud integrity apis"
        required: false
        default: "106218836766"

permissions:
  contents: write

concurrency:
  group: android-apk-${{ github.workflow }}-${{ inputs.tag }}
  cancel-in-progress: true

jobs:
  build-android-apk:
    runs-on: ubuntu-builds-medium
    env:
      GRADLE_OPTS: -Xmx16g
      NODE_OPTIONS: --max_old_space_size=16384
    steps:
      - name: Checkout little-world-native
        uses: actions/checkout@v4
        with:
          path: little-world-native

      - name: Checkout little-world-frontend (sibling)
        uses: actions/checkout@v4
        with:
          repository: a-little-world/little-world-frontend
          ref: ${{ github.event.inputs.COMMIT_REF }}
          path: little-world-frontend
          token: ${{ secrets.BOT_PAT }}

      - name: Install base packages (act only)
        if: ${{ env.ACT }}
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            git curl unzip ca-certificates
          ls -la

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install pnpm
        run: |
          npm i -g pnpm@8
          npm i -g cpx

      - name: Pack and update local frontend package
        run: |
          cd little-world-native
          cat ../little-world-frontend/package.json
          export SETUP_HOST_DOMAIN=true
          export HTTP_SCHEME="https"
          export HOST_DOMAIN=$(echo "${{ github.event.inputs.baseUrl }}" | sed 's|^https\?://||')
          export USE_WSS_WEBSOCKET=true
          ./_scripts/pack_and_update.sh
        
      - name: Install frontend dependencies
        run: pnpm install
        working-directory: little-world-native

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android platforms and build tools
        run: |
          yes | sdkmanager --licenses > /dev/null || true
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Prepare Android signing (optional)
        working-directory: little-world-native
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "Configuring Android signing from secrets"
            echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > android-release.keystore
            node -e '
              const fs = require("fs");
              const creds = {
                android: {
                  keystore: {
                    keystorePath: "android-release.keystore",
                    keystorePassword: process.env.ANDROID_KEYSTORE_PASSWORD || "",
                    keyAlias: process.env.ANDROID_KEY_ALIAS || "",
                    keyPassword: process.env.ANDROID_KEY_PASSWORD || ""
                  }
                }
              };
              fs.writeFileSync("credentials.json", JSON.stringify(creds));
              console.log("Wrote credentials.json");
            '
          else
            echo "ANDROID_KEYSTORE_BASE64 not set. Skipping signing configuration."
          fi
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Verify toolchain
        run: |
          java -version
          node -v
          pnpm -v
          adb --version || true

      - name: Verify EAS auth (whoami)
        working-directory: little-world-native
        shell: bash
        run: |
          if [ -n "${EXPO_TOKEN:-}" ]; then
            npx --yes eas-cli@latest whoami || true
          else
            echo "EXPO_TOKEN not set; EAS will prompt and fail in CI."
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Inject environment values into src/config/environment.ts
        working-directory: little-world-native
        shell: bash
        run: |
          set -euo pipefail
          FILE="src/config/environment.ts"
          cp "$FILE" "$FILE.bak"

          # Inputs from workflow_dispatch
          ENCRYPTED_APP_SECRET='${{ github.event.inputs.encryptedAppSecret }}'
          INNER_KEY='${{ github.event.inputs.innerLayerDecryptionKey }}'
          OUTER_DEV_KEY='${{ github.event.inputs.developmentOnlyOuterLayerDecryptionKey }}'
          GOOGLE_CLOUD_PROJECT_ID='${{ github.event.inputs.googleCloudProjectID }}'
          BASE_URL='${{ github.event.inputs.baseUrl }}'

          # Only replace when inputs are provided (non-empty)
          if [ -n "${ENCRYPTED_APP_SECRET}" ]; then
            sed -i.bak "s|ecryptedNativeSecret: \".*\"|ecryptedNativeSecret: \"${ENCRYPTED_APP_SECRET}\"|" "$FILE"
          fi
          if [ -n "${OUTER_DEV_KEY}" ]; then
            sed -i.bak "s|developmentOnlyOuterLayerDecryptionKey: \".*\"|developmentOnlyOuterLayerDecryptionKey: \"${OUTER_DEV_KEY}\"|" "$FILE"
          fi
          if [ -n "${INNER_KEY}" ]; then
            sed -i.bak "s|localInnerLayerDecryptionKey: \".*\"|localInnerLayerDecryptionKey: \"${INNER_KEY}\"|" "$FILE"
          fi
          if [ -n "${BASE_URL}" ]; then
            # Update backendUrl if present in this config file layout
            sed -i.bak "s|backendUrl: \".*\"|backendUrl: \"${BASE_URL}\"|" "$FILE" || true
          fi
          if [ -n "${GOOGLE_CLOUD_PROJECT_ID}" ]; then
            sed -i.bak "s|googleCloudProjectNumber: \".*\"|googleCloudProjectNumber: \"${GOOGLE_CLOUD_PROJECT_ID}\"|" "$FILE" || true
          fi
          echo "Injected environment values into $FILE"

      - name: Build Android APK (EAS local)
        working-directory: little-world-native
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: npx --yes eas-cli@latest build --platform android --profile preview --local --non-interactive

      - name: Locate APK
        id: locate_apk
        working-directory: little-world-native
        shell: bash
        run: |
          set -euo pipefail
          APK_PATH=""
          if ls build-*.apk >/dev/null 2>&1; then
            APK_PATH=$(ls -t build-*.apk | head -n1)
          elif ls *.apk >/dev/null 2>&1; then
            APK_PATH=$(ls -t *.apk | head -n1)
          else
            APK_PATH=$(ls -t android/app/build/outputs/apk/**/*.apk 2>/dev/null | head -n1 || true)
          fi
          if [ -z "$APK_PATH" ]; then
            echo "No APK found" >&2
            exit 1
          fi
          echo "apk_path=./little-world-native/$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK at $APK_PATH"

      - name: Rename APK with unique name
        id: rename_apk
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.event.inputs.tag }}"
          RUN_NO="${{ github.run_number }}"
          ORIG_PATH="${{ steps.locate_apk.outputs.apk_path }}"
          # Ensure directory exists and compute new path
          BASENAME="app-${TAG}-${RUN_NO}.apk"
          NEW_PATH="little-world-native/${BASENAME}"
          mv "$ORIG_PATH" "$NEW_PATH"
          echo "apk_path=./$NEW_PATH" >> $GITHUB_OUTPUT
          echo "apk_name=$BASENAME" >> $GITHUB_OUTPUT

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.event.inputs.tag }}-${{ github.run_number }}
          path: ${{ steps.rename_apk.outputs.apk_path }}

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.name }}
          prerelease: ${{ github.event.inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_PAT }}

      - name: Upload asset to GitHub Release (clobber)
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_PAT }}
        run: |
          gh release upload "${{ github.event.inputs.tag }}" "${{ steps.rename_apk.outputs.apk_path }}" --clobber