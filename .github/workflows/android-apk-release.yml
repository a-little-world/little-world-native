name: Android Build (EAS local) Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.2.3)"
        required: true
      name:
        description: "Release name (optional)"
        required: false
      prerelease:
        description: "Mark as prerelease (true/false)"
        required: true
        default: "true"
      baseUrl:
        description: "Base URL for backend (e.g., https://api.example.com)"
        required: false
        default: ""
      COMMIT_REF:
        description: "Frontend commit SHA or branch to checkout"
        required: false
        default: "main"
      googleCloudProjectID:
        description: "Google Project ID for cloud integrity apis"
        required: false
        default: "106218836766"
      easBuildTag:
        description: "EAS build type"
        required: false
        default: "preview"
      showDebugPanel:
        description: "Show debug panel"
        required: false
        default: "true"

permissions:
  contents: write

concurrency:
  group: android-apk-${{ github.workflow }}-${{ inputs.tag }}
  cancel-in-progress: true

jobs:
  build-android-apk:
    runs-on: ubuntu-native-builds-large
    env:
      GRADLE_OPTS: -Xmx16g
      NODE_OPTIONS: --max_old_space_size=16384
    steps:
      - name: Checkout little-world-native
        uses: actions/checkout@v4
        with:
          path: little-world-native

      - name: Checkout little-world-frontend (sibling)
        uses: actions/checkout@v4
        with:
          repository: a-little-world/little-world-frontend
          ref: ${{ github.event.inputs.COMMIT_REF }}
          path: little-world-frontend
          token: ${{ secrets.BOT_PAT }}

      - name: Install base packages (act only)
        if: ${{ env.ACT }}
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            git curl unzip ca-certificates
          ls -la

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install pnpm
        run: |
          npm i -g pnpm@8
          npm i -g cpx

      - name: Pack and update local frontend package
        run: |
          cd little-world-native
          cat ../little-world-frontend/package.json
          export SETUP_HOST_DOMAIN=true
          export HTTP_SCHEME="https"
          export HOST_DOMAIN=$(echo "${{ github.event.inputs.baseUrl }}" | sed 's|^https\?://||')
          export USE_WSS_WEBSOCKET=true
          ./_scripts/pack_and_update.sh

      - name: Install frontend dependencies
        run: pnpm install
        working-directory: little-world-native

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android platforms and build tools
        run: |
          yes | sdkmanager --licenses > /dev/null || true
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Prepare Android signing (optional)
        working-directory: little-world-native
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "Configuring Android signing from secrets"
            echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > android-release.keystore
            node -e '
              const fs = require("fs");
              const creds = {
                android: {
                  keystore: {
                    keystorePath: "android-release.keystore",
                    keystorePassword: process.env.ANDROID_KEYSTORE_PASSWORD || "",
                    keyAlias: process.env.ANDROID_KEY_ALIAS || "",
                    keyPassword: process.env.ANDROID_KEY_PASSWORD || ""
                  }
                }
              };
              fs.writeFileSync("credentials.json", JSON.stringify(creds));
              console.log("Wrote credentials.json");
            '
          else
            echo "ANDROID_KEYSTORE_BASE64 not set. Skipping signing configuration."
          fi
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Verify toolchain
        run: |
          java -version
          node -v
          pnpm -v
          adb --version || true

      - name: Verify EAS auth (whoami)
        working-directory: little-world-native
        shell: bash
        run: |
          if [ -n "${EXPO_TOKEN:-}" ]; then
            npx --yes eas-cli@latest whoami || true
          else
            echo "EXPO_TOKEN not set; EAS will prompt and fail in CI."
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Inject environment values into src/config/environment-native.ts
        working-directory: little-world-native
        shell: bash
        run: |
          set -euo pipefail
          FILE="src/config/environment-native.ts"
          cp "$FILE" "$FILE.bak"

          # Inputs from workflow_dispatch
          GOOGLE_CLOUD_PROJECT_ID='${{ github.event.inputs.googleCloudProjectID }}'
          BASE_URL='${{ github.event.inputs.baseUrl }}'

          # Only replace when inputs are provided (non-empty)
          if [ -n "${BASE_URL}" ]; then
            # Update backendUrl if present in this config file layout
            sed -i.bak "s|backendUrl: \".*\"|backendUrl: \"${BASE_URL}\"|" "$FILE" || true
          fi
          if [ -n "${GOOGLE_CLOUD_PROJECT_ID}" ]; then
            sed -i.bak "s|googleCloudProjectNumber: \".*\"|googleCloudProjectNumber: \"${GOOGLE_CLOUD_PROJECT_ID}\"|" "$FILE" || true
          fi

          SHOW_DEBUG_PANEL='${{ github.event.inputs.showDebugPanel }}' # "true" or "false"
          if [ "${SHOW_DEBUG_PANEL}" = "true" ]; then
            sed -i.bak "s|showDebugPanel: .*|showDebugPanel: true,|" "$FILE" || true
          else
            sed -i.bak "s|showDebugPanel: .*|showDebugPanel: false,|" "$FILE" || true
          fi
          echo "Injected environment values into $FILE"

      - name: Build Android APK (EAS local)
        working-directory: little-world-native
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          mv eas.ci.json eas.json
          npx --yes eas-cli@latest build --platform android --profile "${{ github.event.inputs.easBuildTag }}" --local --non-interactive

      - name: Locate Android Build File
        id: locate_build_file
        working-directory: little-world-native
        shell: bash
        run: |
          set -euo pipefail
          BUILD_FILE_PATH=""
          EAS_BUILD_TAG="${{ github.event.inputs.easBuildTag }}"

          # Check for AAB files first (production builds)
          if [ "$EAS_BUILD_TAG" = "production" ]; then
            if ls build-*.aab >/dev/null 2>&1; then
              BUILD_FILE_PATH=$(ls -t build-*.aab | head -n1)
            elif ls *.aab >/dev/null 2>&1; then
              BUILD_FILE_PATH=$(ls -t *.aab | head -n1)
            else
              BUILD_FILE_PATH=$(ls -t android/app/build/outputs/bundle/**/*.aab 2>/dev/null | head -n1 || true)
            fi
          else
            # Check for APK files (preview/development builds)
            if ls build-*.apk >/dev/null 2>&1; then
              BUILD_FILE_PATH=$(ls -t build-*.apk | head -n1)
            elif ls *.apk >/dev/null 2>&1; then
              BUILD_FILE_PATH=$(ls -t *.apk | head -n1)
            else
              BUILD_FILE_PATH=$(ls -t android/app/build/outputs/apk/**/*.apk 2>/dev/null | head -n1 || true)
            fi
          fi

          # Extract the actual file extension from the found file
          if [ -n "$BUILD_FILE_PATH" ]; then
            FILE_EXTENSION="${BUILD_FILE_PATH##*.}"
          else
            # Fallback based on build profile if no file found
            if [ "$EAS_BUILD_TAG" = "production" ]; then
              FILE_EXTENSION="aab"
            else
              FILE_EXTENSION="apk"
            fi
          fi

          if [ -z "$BUILD_FILE_PATH" ]; then
            echo "No $FILE_EXTENSION file found for $EAS_BUILD_TAG build" >&2
            exit 1
          fi
          echo "build_file_path=./little-world-native/$BUILD_FILE_PATH" >> $GITHUB_OUTPUT
          echo "file_extension=$FILE_EXTENSION" >> $GITHUB_OUTPUT
          echo "Found $FILE_EXTENSION at $BUILD_FILE_PATH"

      - name: Rename Android Build File with unique name
        id: rename_build_file
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.event.inputs.tag }}"
          RUN_NO="${{ github.run_number }}"
          ORIG_PATH="${{ steps.locate_build_file.outputs.build_file_path }}"
          FILE_EXT="${{ steps.locate_build_file.outputs.file_extension }}"
          # Ensure directory exists and compute new path
          BASENAME="app-${TAG}-${RUN_NO}.${FILE_EXT}"
          NEW_PATH="${BASENAME}"
          mv "$ORIG_PATH" "$NEW_PATH"
          echo "build_file_path=./$NEW_PATH" >> $GITHUB_OUTPUT
          echo "build_file_name=$BASENAME" >> $GITHUB_OUTPUT

      - name: Upload Android Build File artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ steps.locate_build_file.outputs.file_extension }}-${{ github.event.inputs.tag }}-${{ github.run_number }}
          path: ${{ steps.rename_build_file.outputs.build_file_path }}

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.name }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: ${{ steps.rename_build_file.outputs.build_file_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_PAT }}
